name: CI/CD Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      skip_release:
        description: 'Skip release step'
        required: false
        default: false
        type: boolean

jobs:
  # ============================================================================
  # Job 1: Commit Message Check (only for PRs)
  # ============================================================================
  commitlint:
    name: Check Commit Messages
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: '20'

      - name: Install commitlint
        run: |
          npm install --save-dev @commitlint/cli @commitlint/config-conventional

      - name: Validate commits
        run: |
          npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose

  # ============================================================================
  # Job 2: Build Firmware (Debug & Release)
  # ============================================================================
  build:
    name: Build Firmware (${{ matrix.build_type }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [Debug, Release]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi ninja-build cmake make

      - name: Verify Toolchain
        run: |
          arm-none-eabi-gcc --version
          cmake --version
          ninja --version

      - name: Configure CMake (${{ matrix.build_type }})
        run: |
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                -DCMAKE_TOOLCHAIN_FILE=cmake/gcc-arm-none-eabi.cmake

      - name: Build
        run: |
          cmake --build build -j$(nproc)

      - name: Generate Binary Files
        run: |
          cd build
          arm-none-eabi-objcopy -O ihex ZeroForm_FOC.elf ZeroForm_FOC.hex
          arm-none-eabi-objcopy -O binary ZeroForm_FOC.elf ZeroForm_FOC.bin

      - name: Display Firmware Size (${{ matrix.build_type }})
        run: |
          echo "## Firmware Size (${{ matrix.build_type }})" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          arm-none-eabi-size build/ZeroForm_FOC.elf >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload Build Artifacts (${{ matrix.build_type }})
        uses: actions/upload-artifact@v6.0.0
        with:
          name: firmware-${{ matrix.build_type }}
          path: |
            build/ZeroForm_FOC.elf
            build/ZeroForm_FOC.hex
            build/ZeroForm_FOC.bin
            build/ZeroForm_FOC.map
          retention-days: 30

  # ============================================================================
  # Job 3: Static Code Analysis
  # ============================================================================
  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          cppcheck --enable=warning,style,performance,portability \
                   --suppress=missingIncludeSystem \
                   --suppress=unusedFunction \
                   --error-exitcode=0 \
                   --inline-suppr \
                   --xml --xml-version=2 \
                   -I App/Inc -I Core/Inc \
                   App/Src Core/Src 2> cppcheck-report.xml || true

      - name: Display cppcheck results
        run: |
          echo "## Static Analysis Results" >> $GITHUB_STEP_SUMMARY
          cppcheck --enable=warning,style,performance,portability \
                   --suppress=missingIncludeSystem \
                   --suppress=unusedFunction \
                   --inline-suppr \
                   -I App/Inc -I Core/Inc \
                   App/Src Core/Src 2>&1 | head -100 >> $GITHUB_STEP_SUMMARY || true

      - name: Upload cppcheck report
        uses: actions/upload-artifact@v6.0.0
        with:
          name: cppcheck-report
          path: cppcheck-report.xml
          retention-days: 7

  # ============================================================================
  # Job 4: Release (only on master push)
  # ============================================================================
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [build, static-analysis]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master' && github.event.inputs.skip_release != 'true'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/github @semantic-release/exec

      - name: Download Release firmware
        uses: actions/download-artifact@v7.0.0
        with:
          name: firmware-Release
          path: build-release/

      - name: Download Debug firmware
        uses: actions/download-artifact@v7.0.0
        with:
          name: firmware-Debug
          path: build-debug/

      - name: Prepare release assets
        run: |
          mkdir -p release
          # Release version
          cp build-release/ZeroForm_FOC.elf release/ZeroForm_FOC_Release.elf
          cp build-release/ZeroForm_FOC.hex release/ZeroForm_FOC_Release.hex
          cp build-release/ZeroForm_FOC.bin release/ZeroForm_FOC_Release.bin
          # Debug version
          cp build-debug/ZeroForm_FOC.elf release/ZeroForm_FOC_Debug.elf
          cp build-debug/ZeroForm_FOC.hex release/ZeroForm_FOC_Debug.hex
          cp build-debug/ZeroForm_FOC.bin release/ZeroForm_FOC_Debug.bin

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release
